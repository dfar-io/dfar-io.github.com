<!doctype html><html><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Software/DevOps Engineer">
<link rel="shortcut icon" href=https://dfar.io/favicon.ico>
<link rel=stylesheet href=/css/style.min.css>
<title>Automatically Upgrading Azure Kubernetes Services</title>
</head>
<body><header id=banner>
<h2><a href=https://dfar.io/>Dave Farinelli</a></h2>
<nav>
<ul>
<li>
<a href=/about/ title=about>about</a>
</li>
</ul>
</nav>
</header>
<main id=content>
<article>
<header id=post-header>
<h1>Automatically Upgrading Azure Kubernetes Services</h1><time>September 25, 2019</time></header><p>Azure provides a means to upgrade Kubernetes clusters using the AKS service. This guide will walk you through using an automation account to upgrade the services on a regular basis, making the process something you don’t need to worry about.</p>
<p>Note that you may want to hold off on doing this for production systems – if for some reason an upgrade were to break currently functionality, there is no means for reverting a cluster back to an original version.</p>
<h2 id=create-a-powershell-core-function-app>Create a Powershell Core Function App</h2>
<p>First, create a function app that runs on PowerShell Core:</p>
<p> </p>
<p>After creating the function app, you’ll also want to make sure to increase the standard timeout rate, since this call can take some time to process. Change <strong>host.json</strong> to have the following:</p>
<p>If you have a large number of clusters you’ll be checking regularly, you should use a standard App Service plan instead, to remove the timeout entirely.</p>
<h2 id=import-azure-cli-into-the-function-app>Import Azure CLI into the Function App</h2>
<p>Next, you’ll want to import Azure CLI into the Function App, to allow for calling the <code>az</code> command.</p>
<p>First, you’ll need to install Azure CLI on you local machine. You’ll be copying this directory created into the function app created to use, so after installing, locate the Azure CLI files at <strong>C:\Program Files (x86)\Microsoft SDKs\Azure\CLI2</strong>.</p>
<p>Connect to FTP using the publish profile for the Function App (access this through the portal) and copy the entire <strong>CLI2</strong> folder into the /home directory. __<strong>Make sure that all of the files are copied successfully.</strong></p>
<p>To verify everything is working, run the following command:</p>
<p><code>D:/home/CLI2/wbin/az.cmd</code></p>
<p>If you get a successful call back, you’ve imported Azure CLI correctly and can now write the code to programmatically upgrade the AKS clusters.</p>
<h2 id=create-service-principal>Create Service Principal</h2>
<p>Next, you’ll create a service principal that has access to the clusters in mind, so you have an account that can log in and perform the upgrade duties. Run the following command locally when logged in to the subscription desired:</p>
<p>After this is done, you should receive output showing the name, password, and tenant. Add the three of these as configuration values for the Function App as:</p>
<ul>
<li>AZ_USER – appId</li>
<li>AZ_PASS – password</li>
<li>AZ_TENANT – tenant</li>
</ul>
<h2 id=create-timer-function>Create Timer Function</h2>
<p>Next, create a timer function that runs every day, let’s say at noon:</p>
<p><code>0 0 12 * * *</code></p>
<p>Use the following codebase.</p>
<p>You can run the function to make sure it is running as intended, while commenting out the <code>az aks upgrade</code> line to ensure no upgrades occur.</p>
<h2 id=setting-up-failure-alerts>Setting up Failure Alerts</h2>
<p>The final (optional) step is setting up a means to alert in case of failure. When creating the Function App, an Application Insights resource should have been created as well. Go the ‘Alerts’ section in the App Insight resource, and create an alert:</p>
<p>Add your email as an action group to notify if there is an issue with failures.</p>
<h2 id=reference>Reference</h2>
<p><a href=https://stackoverflow.com/questions/56544059/azure-cli-commands-not-working-inside-azure-function-apps-portal>https://stackoverflow.com/questions/56544059/azure-cli-commands-not-working-inside-azure-function-apps-portal</a></p>
</article>
</main><footer id=footer>
</footer>
</body>
</html>