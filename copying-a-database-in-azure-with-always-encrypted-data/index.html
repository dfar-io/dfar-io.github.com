<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Software/DevOps Engineer"><link rel="shortcut icon" href=https://dfar.io/favicon.ico><link rel=stylesheet href=/css/style.min.css><title>Copying a Database in Azure with Always Encrypted Data</title></head><body><header id=banner><h2><a href=https://dfar.io/>Dave Farinelli</a></h2><nav><ul><li><a href=/about/ title=about>about</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>Copying a Database in Azure with Always Encrypted Data</h1><time>June 25, 2019</time></header><p>When trying to copy a database with Always Encrypted data (say, to a different environment), you’ll generally want to recycle the Column Master Key used to match the vault stored in the same Azure resource group. This takes a little bit of work to do:</p><h2 id=pre-reqs>Pre-Reqs</h2><p>You’ll need to have the following software installed:</p><ul><li>SSMS</li><li>Azure CLI</li></ul><p>You’ll also need to make sure the database you’re copying from has a key that already exists. Run the following query on your newly copied database:</p><p>And then check to see if the key exists in the appropriate vault:</p><p>If it exists, you’ll be able to copy the database over without issue.</p><h2 id=procedure>Procedure</h2><p>Create a new key in the Key Vault:</p><p>Next, create a new Column Master Key, using the created key above.</p><p></p><p>With two CMKs, rotate the initial CMK (using credentials from the source key vault, and then the destination key vault).</p><p></p><p>Next, clean up the previous CMK:</p><p></p><p>After this is done, you can delete the old CMK.</p></article></main><footer id=footer></footer></body></html>