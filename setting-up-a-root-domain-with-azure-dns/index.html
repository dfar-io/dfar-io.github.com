<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Software/DevOps Engineer"><link rel="shortcut icon" href=https://dfar.io/favicon.ico><link rel=stylesheet href=/css/style.min.css><title>Setting Up a Root Domain with Azure DNS</title></head><body><header id=banner><h2><a href=https://dfar.io/>Dave Farinelli</a></h2><nav><ul><li><a href=/about/ title=about>about</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>Setting Up a Root Domain with Azure DNS</h1><time>August 30, 2019</time></header><p>When setting up Azure CDN, you may want to use a naked domain (yourdomain.com) to access. It’s a little tricky, so here’s how I set it up:</p><h2 id=creation-and-verification>Creation and Verification</h2><p>Create the CDN profile and endpoint in Azure.</p><p>Next set up a custom domain:</p><p></p><p>To do this, you’ll need to modify the value highlighted as a CNAME record for your domain’s DNS. It will look like this:</p><ul><li>Host: cdnverify.</li><li>Value: cdnverify..azureedge.net</li></ul><h2 id=setting-up-ssl-and-https-redirect>Setting up SSL and HTTPS Redirect</h2><p>With the domain working, you’ll notice that you only have an insecure connection in place, so let’s set that up.</p><p>One of the disadvantages of using a root domain is that you cannot use the Azure CDN self-generated certificates. This means you’ll have to bring your own certificate in. There are three options immediately available:</p><ol><li>Purchase a certificiate from Azure (easy and reliable but starts at ~$70)</li><li>Purchase a certificate from a reputable CA (Such as from Namecheap, can purchase a cert as low as ~$8 a year, although these certs are not as secure).</li><li>Use the manual process at Let’s Encrypt to generate a certificate (free, but will need to be renewed regularly).</li></ol><h3 id=obtaining-a-let8217s-encrypt-certificate-using-windows>Obtaining a Let’s Encrypt Certificate Using Windows</h3><p>To use the manual process, you’ll need to start with the following:</p><p>Install WSL (Ubuntu 18.04) onto your computer, and open a CLI.</p><p>Install <code>certbot</code> with the following commands:</p><p>And then run <code>certbot</code> in manual mode:</p><p><code>sudo certbot certonly --manual --preferred-challenges dns-01</code></p><p>You’ll need to create a TXT record with the data provided from <code>certbot</code>. After creating the TXT record, use <a href=https://dnschecker.org/>https://dnschecker.org</a> to verify the TXT record has been resolved before progressing (may take 5-10 minutes).</p><p>Once you’ve verified (and deleted the TXT record generated), you’ll have a certificate generated with both a certificate and private key.</p><p>Next, you’ll add these to an Azure Key Vault to finish setting up HTTPS.</p><h2 id=adding-certificate-to-key-vault-configuring-certificate>Adding Certificate to Key Vault, Configuring Certificate</h2><p>To add the certificate to the keyvault, you need to first convert it to PFX (using WSL):</p><p><code>openssl pkcs12 -export -in fullchain.pem -inkey privkey.pem -out cert.pfx -passout pass:password</code></p><p>Now back to using Azure CLI, import the certificate:</p><p><code>az keyvault certificate import --vault-name VAULT_NAME -n cert -f cert.pfx --password password</code></p><p>Once the certificate is added, set up Custom HTTPS for the endpoint:</p><p></p><p>Final steps are setting up a service principal for access with the command provided above. (Make sure to use <code>Connect-AzAccount</code>). Once this is done, you’ll need to allow some time (around 6-8 hours) to pass for allowing certificate import and CDN provisioning.</p><h2 id=verification>Verification</h2><p>To make sure everything is in place, first check to ensure the status shows Custom HTTPS being enabled:</p><p></p><p>Afterwards, try accessing your site using HTTPS to confirm everything working.</p><h2 id=redirecting-all-non-httproot-traffic>Redirecting all non-HTTP/root Traffic</h2><p>The last step to getting this working is setting anything not going to <code>https://&lt;yourdomain>.com</code> to the correct place. This can be done in the Premium CDN with Verizon plan by changing the traffic rules in the Custom rules engine:</p><p></p><p>This will take some time to propagate, you’ll know it’s complete when you see “Active XML” next to the rule.</p><p>Once this is done, you can validate by trying to access the site using HTTP, and seeing it redirect to HTTPS (make sure to use an Incognito tab if using Chrome).</p></article></main><footer id=footer></footer></body></html>