<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Software/DevOps Engineer"><link rel="shortcut icon" href=https://dfar.io/favicon.ico><link rel=stylesheet href=/css/style.min.css><title>Setting up Graylog in Azure</title></head><body><header id=banner><h2><a href=https://dfar.io/>Dave Farinelli</a></h2><nav><ul><li><a href=/about/ title=about>about</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>Setting up Graylog in Azure</h1><time>February 20, 2020</time></header><p>To get started with installing Graylog, do the following:</p><p>Create a VM using the following:</p><ul><li>Image: Ubuntu 18.04 LTS</li><li>Minimum Size: B2s (~$30/month)</li><li>Open ports 80,443,22</li></ul><p>SSH into the server and follow <a href=https://docs.graylog.org/en/3.1/pages/installation/os/ubuntu.html>this guide</a> to get Graylog installed.</p><p>To set up public access, set the following variables in Graylog config file (make sure to include the leading slash in external_uri):</p><pre tabindex=0><code>http_bind_address = PRIVATE_IP
http_external_uri = http://&lt;PUBLIC_IP&gt;/
</code></pre><p>Once fully installed, set up an Apache reverse proxy:</p><pre tabindex=0><code>sudo apt-get install apache2 -y
sudo a2enmod proxy_http proxy_ajp rewrite deflate headers proxy_balancer proxy_connect proxy_html ssl lbmethod_byrequests slotmem_shm proxy
</code></pre><p>Edit <code>/etc/apache2/sites-enabled/000-default.conf</code>:</p><pre tabindex=0><code>ProxyPass &#34;/&#34;  &#34;http://PRIVATE_IP:9000/&#34;
ProxyPassReverse &#34;/&#34;  &#34;http://PRIVATE_IP:9000/&#34;
</code></pre><p>Then restart both servers:</p><pre tabindex=0><code>sudo systemctl restart graylog-server.service
sudo systemctl restart apache2
</code></pre><p>To verify installation, access at &lt;IP_ADDRESS> to verify the installation. If you see the Graylog login screen, you&rsquo;ve successfully set up the server.</p><p>Finish by setting the SSH networking rule to a trusted IP to improve security.</p><h2 id=set-up-https-using-let8217s-encrypt>Set up HTTPS using Let’s Encrypt</h2><p>To set up HTTPS using Let’s Encrypt, use the <a href=https://certbot.eff.org/lets-encrypt/ubuntubionic-apache>Certbot</a> directions.</p><p>Once that’s done, make sure to change <code>http_external_uri</code> in the Graylog config file and restart Graylog.</p><h2 id=send-kubernetes-logs-to-graylog>Send Kubernetes Logs to Graylog</h2><p>First, SSH into the server and configure Elasticsearch (<code>/etc/elasticsearch/elasticsearch.yml</code>) to bind to the private IP of the VM:</p><p><code>network.host: PRIVATE_IP</code></p><p>Restart Elasticsearch, then configure Graylog to listen to the new Elasticsearch host:</p><p><code>elasticsearch_hosts = http://PUBLIC_IP:9200</code></p><p>Restart Graylog, then open the firewall to allow for port 9200 to be accessible by the cluster IP. Confirm access by trying to hit port 9200.</p><p>Next, set up an input in Graylog.</p><p>After that, create the RBAC role for the cluster (<em>fluentd-rbac.yml</em>):</p><p>Then create the daemonset, changing the container environment variables as needed (<em>fluentd-daemonset.yml</em>):</p><p>Deploy both of these out:</p><p>Then check the logs of the daemonset to confirm correct connection:</p><h2 id=sending-azure-app-service-logs-to-graylog>Sending Azure App Service Logs to Graylog</h2><p>To get started, create the following:</p><ul><li>Azure Function App</li><li>Azure Event Hubs</li></ul><p>For the App Service in place, enable “Diagnostic logs” and send them to the Event Hub.</p><p>TO BE CONTINUED</p><h2 id=increase-heap-size>Increase Heap Size</h2><p>To increase the heap size, edit <code>/etc/default/graylog-server</code>, then restart <code>graylog-server.service</code>.</p><h2 id=references>References</h2><p><a href=https://mherman.org/blog/logging-in-kubernetes-with-elasticsearch-Kibana-fluentd/#fluentd>https://mherman.org/blog/logging-in-kubernetes-with-elasticsearch-Kibana-fluentd/#fluentd</a></p></article></main><footer id=footer></footer></body></html>