<!doctype html><html><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Software/DevOps Engineer">
<link rel="shortcut icon" href=https://dfar.io/favicon.ico>
<link rel=stylesheet href=/css/style.min.css>
<title>Viewing Traffic to Azure VMs using NSG Flow Logs</title>
</head>
<body><header id=banner>
<h2><a href=https://dfar.io/>Dave Farinelli</a></h2>
<nav>
<ul>
<li>
<a href=/about/ title=about>about</a>
</li>
</ul>
</nav>
</header>
<main id=content>
<article>
<header id=post-header>
<h1>Viewing Traffic to Azure VMs using NSG Flow Logs</h1><time>August 19, 2019</time></header><p>Setting up NSG flow logs allows for viewing the traffic coming in through a network security group. This can be useful for a few things:</p>
<ul>
<li>Troubleshooting access issues (maybe something shouldn’t have access, or vise versa).</li>
<li>Providing logging on the traffic accessing a server.</li>
</ul>
<p>You’ll need the following to get started with this guide:</p>
<ul>
<li>Ensure that a network watcher is configured.</li>
<li>An Azure subscription with the Insights provider installed.</li>
<li>An existing Network Security Group.</li>
<li>A storage account (ideally stored in the same resource group) that will hold the log data.</li>
</ul>
<h2 id=configuration>Configuration</h2>
<p>Go into Network Watcher and click on ‘NSG Flow Logs’:</p>
<p> </p>
<p>Turn on Flow logs, and select the storage account to store logs in. A few notes here:</p>
<ul>
<li>If retention is kept at 0, all logs will stay in the storage account forever. Useful for audits, but will end up costing more in the long run. (I personally set to 7 days).</li>
</ul>
<p> </p>
<h2 id=accessing-logs>Accessing Logs</h2>
<p>For viewing the logs, you can either use the Azure Portal or use the <a href=https://azure.microsoft.com/en-us/features/storage-explorer/>Microsoft Azure Storage Explorer</a>.</p>
<p>View the <strong>insights-logs-networksecuritygroupflowevent</strong> container in the configured storage account.</p>
<p>Access the PT1H.json file.</p>
<p> </p>
<p>The number associates to the following:</p>
<ol>
<li>Timestamp</li>
<li>Inbound IP (coming in from Internet)</li>
<li>Outbound IP (going through the NSG)</li>
<li>Inbound Port</li>
<li>Outbound Port</li>
<li>Protocol</li>
<li>Traffic Flow (I – Inbound, O – Outbound)</li>
<li>Acceptance (A – Allowed, D – Denied)</li>
</ol>
<h2 id=reference>Reference</h2>
<p><a href=https://docs.microsoft.com/en-us/azure/network-watcher/network-watcher-nsg-flow-logging-portal>https://docs.microsoft.com/en-us/azure/network-watcher/network-watcher-nsg-flow-logging-portal</a></p>
</article>
</main><footer id=footer>
</footer>
</body>
</html>